name: Quality Gates

on:
  pull_request:
  push:
    branches: [main]

permissions:
  contents: read

env:
  PYTHONUNBUFFERED: "1"
  PYTHONDONTWRITEBYTECODE: "1"
  PIP_NO_CACHE_DIR: "1"
  PIP_DISABLE_PIP_VERSION_CHECK: "1"
  PIP_DEFAULT_TIMEOUT: "100"

jobs:
  quality:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Upgrade pip
        run: |
          python -m pip install --no-cache-dir --upgrade pip setuptools wheel

      - name: Install dependencies
        run: |
          pip install --no-cache-dir -e .[dev,ci]

      - name: Verify installation
        run: |
          pip list
          python -c "import pytest; print(f'pytest: {pytest.__version__}')"

      - name: Run quality checks
        run: |
          python -m pytest tests/ci/ -v --tb=short --strict-markers

  performance:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: quality
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --no-cache-dir --upgrade pip setuptools wheel
          pip install --no-cache-dir -e .[dev,ci]

      - name: Debug test discovery
        run: |
          echo "=== Python Environment ==="
          which python
          python --version
          echo "=== Installed Packages ==="
          pip list | grep -E "(pytest|student-mentor)" || echo "No packages"
          echo "=== Test Discovery ==="
          python -m pytest tests/perf/ --collect-only -q || echo "No tests"

      - name: Run performance tests
        run: |
          if [ -d "tests/perf" ]; then
            python -m pytest -v tests/perf/ --durations=10
          else
            echo "⚠️ tests/perf not found"
          fi
