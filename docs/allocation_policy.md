# سیاست تخصیص فاز ۳

این فاز از موتور تخصیص بر پایه **سیاست مبتنی بر قوانین** و **رتبه‌بندی پایدار** اجرا می‌شود.

## ردگیری (Trace)

- برای هر قانون کد ثابتی از مجموعه `{GENDER_MATCH, GROUP_ALLOWED, CENTER_ALLOWED, REG_STATUS_ALLOWED, CAPACITY_AVAILABLE, SCHOOL_TYPE_COMPATIBLE, GRADUATE_NOT_TO_SCHOOL, MANAGER_CENTER_GATE}` ثبت می‌شود.
- هر ردیف Trace شامل `code`، وضعیت `passed` و جزئیات بدون اطلاعات هویتی است.
- در حالت `fast_fail=True` ارزیابی پس از اولین شکست متوقف می‌شود ولی نتیجه نهایی تغییر نمی‌کند.
- محدودیت `trace_limit_rejected` حداکثر تعداد رکورد شکست را کنترل می‌کند.

## قوانین

1. **GENDER_MATCH**: جنسیت دانش‌آموز و منتور باید یکسان باشد.
2. **GROUP_ALLOWED**: کد گروه دانش‌آموز در مجموعه‌ی گروه‌های مجاز منتور باشد.
3. **CENTER_ALLOWED**: مرکز ثبت‌نام دانش‌آموز در مراکز مجاز منتور وجود داشته باشد.
4. **REG_STATUS_ALLOWED**: وضعیت ثبت‌نام دانش‌آموز فقط می‌تواند یکی از مقادیر {0, 1, 3} باشد.
5. **CAPACITY_AVAILABLE**: منتور فعال باشد و بار فعلی کمتر از ظرفیت باشد.
6. **SCHOOL_TYPE_COMPATIBLE**: دانش‌آموز ویژه فقط به منتور مدرسه با کد مدرسه منطبق تخصیص می‌یابد و دانش‌آموز عادی هرگز به منتور مدرسه نمی‌رود.
7. **GRADUATE_NOT_TO_SCHOOL**: فارغ‌التحصیل (edu_status == 0) به منتور مدرسه تخصیص داده نمی‌شود.
8. **MANAGER_CENTER_GATE**: اگر منتور مدیر دارد، مرکز دانش‌آموز باید در فهرست مراکز مجاز آن مدیر باشد؛ در غیر این صورت رد با دلیل `manager_centers_not_found` ثبت می‌شود.

## رتبه‌بندی

رتبه‌بندی منتورهای قبول‌شده با کلید پایدار زیر انجام می‌شود:

1. `occupancy_ratio = current_load / capacity` (در صورت `capacity == 0` مقدار 1.0 در نظر گرفته می‌شود).
2. `current_load` کمتر بهتر است.
3. `mentor_id` کوچکتر (به صورت عدد صحیح) ارجح است.

منتور با کمترین کلید انتخاب می‌شود. مرتب‌سازی پایدار تضمین می‌کند که ترتیب اولیه در صورت تساوی کامل حفظ شود.

## خروجی اکسل امن

- خروجی‌های `CSV` به‌صورت استریم تولید می‌شوند تا برای فایل‌های بزرگ (بیش از ۱۰ هزار ردیف) به حافظهٔ اضافی نیاز نباشد.
- تمامی سلول‌ها پس از نرمال‌سازی `NFKC`، حذف نویسه‌های صفرعرض، تبدیل ارقام فارسی/عربی به لاتین و پاک‌سازی حروف «ي/ك» ذخیره می‌شوند.
- برای جلوگیری از تزریق فرمول در اکسل، مقدارهایی که با یکی از کاراکترهای `=، +، -، @` یا تب شروع شوند با پیشوند `'` ذخیره می‌شوند.
- تنظیم `--bom utf8|none` امکان کنترل نوشتن BOM را فراهم می‌کند و تمام ستون‌ها طبق RFC4180 با کوتیشن کامل نوشته می‌شوند.

## CLI استریم‌شونده

- اجرای `scripts/phase3_cli.py` با گزینه‌های `--in`، `--mentors` و `--out` داده‌ها را بدون نگهداری کامل در حافظه پردازش می‌کند.
- منبع دادهٔ خروجی به‌صورت ژنراتوری به صادرکننده تحویل می‌شود تا حتی برای فایل‌های ۱۰۰هزار رکوردی نیز پیک حافظه زیر ۲۰۰ مگابایت باقی بماند.
- کلید `--ui text` واسط متنی فعال می‌کند؛ نبود Tkinter به شکل خودکار به همین حالت متنی سوئیچ می‌شود.
- گزینه‌های `--text-page-size` و `--text-page` اجازه می‌دهند خروجی متنی بدون بافر کامل، صفحه‌به‌صفحه چاپ شود؛ هر صفحه فقط اندازهٔ درخواستی ردیف تولید می‌کند و با استفاده از `seek_page` روی نمایهٔ تنبل مستقیماً به ابتدای صفحه می‌پرد.
- مقادیر نامعتبر صفحه/اندازه (صفر، منفی یا خارج از محدودهٔ نتایج) پیش از رندر با پیام فارسی خطا گزارش می‌شوند؛ پیام شامل بیشینهٔ صفحه، تعداد کل ردیف‌ها و پیشنهاد نزدیک‌ترین صفحهٔ معتبر با ارقام فارسی است تا اجرای CI همواره قطعی باقی بماند.
- گزینه‌های `--telemetry-out` و `--telemetry-format json|csv` خلاصهٔ کارایی را روی دیسک ذخیره می‌کنند.

## نمایه‌سازی و ابطال انتخاب

- متد `validate_page(filters, page_size)` در `TraceFilterIndex` تعداد کل نتایج و تعداد صفحات را بدون بازسازی کامل نمایه بازمی‌گرداند؛ اگر پنجره‌های قبلی در کش باشند هیچ اسکن اضافی انجام نمی‌شود.
- متد `queue_selection_update`/`mark_selection_dirty` فقط ردیف‌هایی را که وضعیت `is_selected` آنها تغییر کرده است بازخوانی می‌کند و صرفاً کش فیلترهای `selected_only` را باطل می‌کند تا سایر فیلترها گرم بمانند.
- رابط گرافیکی با فراخوانی `refresh_after_selection_toggle` فقط صفحهٔ فعال را دوباره‌خوانی می‌کند و در fallback لیست‌باکس نیز همان بازه‌های تنبل بارگذاری می‌شود.

## رابط کاربری گرافیکی مجازی‌سازی‌شده

- ویجت `ttk.Treeview` فقط ۲۰۰ ردیف در هر صفحه بارگذاری می‌کند و کش درون حافظه به ۴۰۰ ردیف محدود شده است تا پیمایش مجموعه‌های حجیم بدون فشار حافظه انجام شود.
- شاخص‌های معکوس گروه و مرکز به‌صورت تنبل و افزایشی ساخته می‌شوند تا پیمایش فیلترشده با مرتبهٔ زمانی `O(window)` انجام شود و تنها بازه‌های موردنیاز هر صفحه بارگذاری شوند.
- صفحه‌بندی با کلیدهای `PgUp/PgDn` یا دکمه‌های «صفحه قبل/بعد» قابل کنترل است و کش درونی حداکثر دو صفحه (۴۰۰ ردیف) را نگه می‌دارد.
- در fallback مبتنی بر `Listbox` نیز همان بازه‌های نمایه‌شده به‌صورت batchهای ثابت بارگذاری می‌شوند و تنظیمات صفحه/اندازه از CLI اعمال می‌گردد تا تجربهٔ یکسانی در محیط‌های فاقد Treeview ارائه شود.
- انتخاب هر ردیف Trace جزئیات فارسی قوانین را در ناحیهٔ متنی نشان می‌دهد؛ میانبرهای `↑/↓/Enter/Esc` نیز حفظ شده‌اند.
- در محیط‌های بدون Tkinter، واسط متنی همان اطلاعات را در قالب جدول فارسی نمایش می‌دهد و با پارامترهای صفحه‌بندی می‌توان به ردیف‌های عمیق دسترسی داشت.

## یادداشت‌های UX فارسی

- خطاهای صفحه‌بندی هم در CLI و هم در حالت متنی با تبدیل ارقام به فارسی، جداکنندهٔ هزارگان `٬` و گزارش تعداد کل ردیف‌ها نمایش داده می‌شوند تا تجربهٔ کاربری یکدست باقی بماند.

## تله‌متری عملکرد

- ماژول `observe.perf` با استفاده از `tracemalloc` اوج مصرف حافظه و زمان اجرای عملیات را اندازه‌گیری و صدک‌های p50/p95/max را محاسبه می‌کند.
- موتور تخصیص شمارنده‌هایی مانند `allocation_policy_pass_total{rule=...}` و `allocation_no_candidate_total` را ثبت می‌کند تا تحلیل روند عبور/شکست قوانین ساده باشد.
- CLI آمار تله‌متری و شمارنده‌ها را در پایان هر اجرا ثبت می‌کند و می‌توان از آن برای پایش بودجه‌های کارایی استفاده کرد.
- خروجی JSON شامل `durations`، صدک‌های `p50/p95/max` و `mem_peak` به همراه شمارنده‌ها ذخیره می‌شود و از طریق `PerfSummary.from_json` قابل بارگذاری مجدد است.

