name: Phase 2 Counter CI

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    paths:
      - 'src/phase2_counter_service/**'
      - 'tests/phase2_counter_service/**'
      - 'scripts/post_migration_checks.py'
      - 'scripts/validate_artifacts.py'
      - 'requirements*.txt'
      - '.github/workflows/ci.yml'
  push:
    branches: [main]
    paths:
      - 'src/phase2_counter_service/**'
      - 'tests/phase2_counter_service/**'
      - 'scripts/post_migration_checks.py'
      - 'scripts/validate_artifacts.py'
      - 'requirements*.txt'
      - '.github/workflows/ci.yml'
  workflow_dispatch:

concurrency:
  group: phase2-counter-${{ github.ref }}
  cancel-in-progress: true

jobs:
  gates:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.11', '3.12']
    env:
      PYTEST_DISABLE_PLUGIN_AUTOLOAD: '1'
      LC_ALL: C.UTF-8
      PYTHONUTF8: '1'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements*.txt') }}-${{ matrix.python-version }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt -r requirements-dev.txt

      - name: Run fault injection tests
        run: make fault-tests

      - name: Run static analysis gates
        run: make static-checks

      - name: Run full CI checks (coverage + post-validators)
        if: matrix.python-version == '3.11'
        run: make ci-checks

  security-scan:
    runs-on: ubuntu-latest
    needs: gates
    env:
      PYTEST_DISABLE_PLUGIN_AUTOLOAD: '1'
      UI_MINIMAL: '1'
      LC_ALL: C.UTF-8
      PYTHONUTF8: '1'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies for security gate
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt -r requirements-dev.txt bandit types-PyYAML

      - name: Run static security checks (با خلاصه فارسی)
        run: make static-checks
