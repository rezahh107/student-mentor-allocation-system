name: Windows Smoke

on:
  push:
  pull_request:

jobs:
  smoke:
    runs-on: windows-latest
    env:
      METRICS_TOKEN: test-token-ci
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Set UTF-8 codepage
        shell: pwsh
        run: chcp 65001

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Upgrade pip
        shell: pwsh
        run: python -m pip install --upgrade pip

      - name: Install project
        shell: pwsh
        run: python -m pip install -e .

      - name: Windows smoke (uvicorn main:app)
        shell: pwsh
        run: ./tools/ci/win_smoke.ps1

      - name: Run pytest with strict scoring
        shell: pwsh
        run: |
          $env:PYTHONWARNINGS = "error"
          $PyOut = & python -m pytest -q 2>&1 | Tee-Object -Variable PyStream
          $pytestStatus = $LASTEXITCODE
          $PyStream | Out-Host
          $joined = ($PyStream | Out-String)
          $joined | python tools/ci/parse_pytest_summary.py --gui-out-of-scope \
            --evidence "AGENTS.md::2 Setup & Commands" \
            --evidence "AGENTS.md::3 Absolute Guardrails" \
            --evidence "AGENTS.md::8 Testing & CI Gates" \
            --evidence "AGENTS.md::10 User-Visible Errors" \
            --fail-under 100
          if ($pytestStatus -ne 0) { exit $pytestStatus }
