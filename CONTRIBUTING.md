# مشارکت در سامانه تخصیص دانش‌آموز و مربی

این مخزن با فرض اجرای آفلاین در CI پیکربندی شده است. لطفاً پیش از ارسال Pull Request موارد زیر را رعایت کنید:

## اجرای تست‌ها

1. وابستگی‌ها را فقط با قفل‌های مخزن نصب کنید:
   ```bash
   python -m scripts.deps.ensure_lock --root . install --attempts 3
   python -m pip install --no-deps -e .
   python -m pip check
   ```
2. تست‌ها باید بدون پلاگین‌های اضافی pytest اجرا شوند. محیط CI همیشه `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1` را تنظیم می‌کند، و ما شیم‌های محلی برای `xdist.plugin` و `pytest_timeout` داریم که در فایل `sitecustomize.py` ثبت می‌شوند. اگر پلاگین‌های واقعی نصب باشند، شیم‌ها به صورت خودکار به آن‌ها اجازهٔ تقدم می‌دهند؛ در حالت آفلاین، شیم‌ها فقط گزینه‌های سازگاری را اضافه می‌کنند.
3. برای مشاهدهٔ خلاصهٔ تست‌ها، فرمان زیر را اجرا کنید تا خروجی‌های مورد نیاز Strict Scoring ساخته شود:
   ```bash
   PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 pytest -c pytest.min.ini -q
   ```
   این فرمان فایل‌های `reports/pytest.json` و `reports/pytest-summary.txt` را تولید می‌کند و می‌توانید آن‌ها را با `python strict_report.py` اعتبارسنجی کنید.

> ℹ️ **Pytest حداقلی:** برای اجرای یک ماژول مشخص (مثلاً اسناد ویندوز) از الگوی زیر استفاده کنید تا شیم‌های `sitecustomize.py` فعال و پلاگین‌های ناخواسته غیرفعال شوند:
> ```bash
> PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 pytest tests/docs/test_windows_install_guide.py -q
> ```

## یادداشت‌های Windows

- پیش از تغییرات وابسته به محیط، `pwsh -NoLogo -File scripts/win/00-diagnose.ps1` را اجرا کنید تا نسخهٔ Python 3.11، ابزارهای ساخت و Docker/WSL بررسی شوند.
- نصب پکیج‌ها در ویندوز باید از طریق `scripts/win/10-venv-install.ps1` انجام شود؛ این اسکریپت `uvloop` را حذف و `tzdata==2025.2` را تضمین می‌کند.
- برای تولید `.env` و اجرای smoke test‌ها، از زنجیرهٔ `20-create-env.ps1` → `30-services.ps1` → `40-run.ps1` → `50-smoke.ps1` استفاده کنید و نتایج را در Pull Request ذکر کنید.

## دیباگ و حالت‌های آفلاین

- در صورتی که Redis واقعی در دسترس نباشد، متغیر `SMA_TEST_FAKE_REDIS=1` یک backend قطعی و قابل پاک‌سازی را فعال می‌کند. این backend در آزمون‌ها از نام‌فضای منحصربه‌فردی استفاده می‌کند تا اجراهای موازی با `pytest-xdist` (واقعی یا شبیه‌سازی شده) تداخلی ایجاد نکند.
- بسته‌های اختیاری مانند `opentelemetry` در CI الزاماً نصب نمی‌شوند؛ ما نسخهٔ مینیمال آن‌ها را در `src/sma/_local_opentelemetry` نگه‌داری می‌کنیم. در صورت نصب نسخهٔ اصلی، همانند پلاگین‌ها، به‌طور خودکار در اولویت قرار می‌گیرد.

## سبک کدنویسی

- قالب‌بندی: `black` (line-length=88) و `isort` با پروفایل black.
- بررسی ایستا: `ruff`, `mypy --strict`, و `bandit -q` باید بدون هشدار اجرا شوند.
- ساعت سیستم: هر تست باید از clock تزریق‌شده با منطقهٔ زمانی `Asia/Tehran` استفاده کند؛ از `datetime.now()` مستقیم استفاده نکنید.

## تماس

برای پرسش‌های مرتبط با امنیت، RBAC، یا الزامات مشاهده‌پذیری به بخش‌های متناظر در `AGENTS.md` مراجعه کنید (به‌ویژه بندهای 6 و 9). هر ویژگی جدید باید شواهد دقیق از آزمون‌ها ارائه کند تا توسط `strict_report.py` پذیرفته شود.

