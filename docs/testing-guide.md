# Testing Guide

این سند خلاصه‌ای از رویه‌های آزمون برای سامانهٔ تخصیص مربی است و روی سناریوهای یکپارچه‌سازی و پایداری پردازش اکسل تمرکز دارد.

> ⚠️ **محیط لوکال:** در بیلد فعلی تمام میان‌افزارهای امنیتی (RateLimit، Auth) غیرفعال شده‌اند. بخش‌های مرتبط با این قابلیت‌ها تنها پس از بازگردانی کد تولیدی معتبر هستند.

## اجرای تست‌های یکپارچه‌سازی

1. وابستگی‌ها را نصب کنید:
   ```bash
   make init
   ```
2. تست‌های یکپارچه‌سازی هسته را با پاک‌سازی خودکار وضعیت ردیس و پایگاه‌داده اجرا کنید:
   ```bash
   PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 pytest tests/integration/ -v --tb=short --maxfail=1
   ```
3. برای مشاهده جزئیات پوشش کد و گزارش خرابی‌های مرتبط با میان‌افزار، فرمان زیر پیشنهاد می‌شود:
   ```bash
   PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 pytest tests/integration/test_middleware_chain.py \
       --cov=sma --cov-report=term-missing:skip-covered --log-cli-level=DEBUG
   ```

## قواعد نرمال‌سازی فارسی و اکسل

- همهٔ متن‌ها با `sanitize_text` از فاز ۶ به حالت NFKC تبدیل می‌شوند، ارقام فارسی/عربی به ASCII تبدیل می‌شوند و کاراکترهای صفر‌عرض حذف می‌شوند.
- شماره‌های همراه باید پس از نرمال‌سازی با الگوی `^09\d{9}$` همخوان باشند. پیام خطای کاربر نهایی: «شمارهٔ همراه باید با ۰۹ شروع شود و دقیقاً ۱۱ رقم باشد.»
- برای جلوگیری از تزریق فرمول در اکسل، ستون‌های متن آزاد با `guard_formula` پیشوند `'` دریافت می‌کنند و ستون‌های حساس همیشه به‌صورت متنی (quoted) ذخیره می‌شوند.
- فایل‌های بزرگ (بیش از ۱۰۰ مگابایت یا بیش از یک میلیون ردیف) باید به‌صورت جریانی (streaming) خوانده شوند؛ از ژنراتورهای chunk-محور و ابزار `iter_chunks` برای کنترل مصرف حافظه استفاده کنید.

## ترتیب میان‌افزار FastAPI

- ترتیب اجرای صحیح در محیط تولید: **RateLimit → Idempotency → Auth**. هر تغییری در پیکربندی باید با اجرای `tests/integration/test_middleware_chain.py` تأیید شود؛ این تست در بیلد محلی غیرفعال است.
- زنجیرهٔ میان‌افزار در CI با `middleware_order_validator` بررسی می‌شود و در صورت نقض، پیام خطای فارسی «زنجیره میان‌افزار با الگوی RateLimit→Idempotency→Auth هم‌خوانی ندارد» چاپ خواهد شد. در نسخهٔ فعلی این بررسی صرفاً جهت اطلاع باقی مانده و نیازمند بازگردانی میان‌افزارهاست.

## عیب‌یابی تست‌های شکست‌خورده

- از فیکچر `get_debug_context` در `tests/integration/conftest.py` استفاده کنید تا کلیدهای ردیس، کوئری‌های ثبت‌شده و زمان اجرا در پیام خطا درج شود.
- در صورت مشاهدهٔ کلیدهای ناپاک در ردیس، پیغام «کلیدهای ردیس پاک‌سازی نشدند» همراه با نام namespace ثبت خواهد شد؛ ابتدا فیکچر `clean_redis_state` را بررسی کنید.
- برای تشخیص مسائل مربوط به تلاش‌های مجدد (retry)، از تزیین‌کنندهٔ `@pytest.mark.flaky(reruns=3, reruns_delay=2)` استفاده کنید و لاگ‌های مرتبط با backoff را در خروجی JSON بررسی کنید.

## نکات اضافی

- همهٔ تست‌ها با ناحیهٔ زمانی Asia/Tehran اجرا می‌شوند؛ زمان‌ها باید از ساعت تزریق‌شده استفاده کنند و از `datetime.now()` مستقیم اجتناب شود.
- در محیط CI (خصوصاً GitHub Actions) فرض می‌شود که ردیس و پایگاه‌داده حالت آلوده دارند؛ همیشه پیش و پس از تست‌ها پاک‌سازی انجام دهید.
- برای اجرای مجموعهٔ Persian Excel edge cases در محیط محلی:
  ```bash
  PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 pytest tests/spec/test_persian_excel_normalization.py -v --hypothesis-show-statistics
  ```
