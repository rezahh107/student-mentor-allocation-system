# pytest.ini (نسخه اصلاح شده)

[pytest]
# ═══════════════════════════════════════════════════════════════
# 🎯 تنظیمات اصلی pytest
# ═══════════════════════════════════════════════════════════════
minversion = 7.0
testpaths = tests
pythonpath = src

# ═══════════════════════════════════════════════════════════════
# 🚀 تنظیمات اجرا و گزارش‌دهی
# ═══════════════════════════════════════════════════════════════
addopts =
    -ra
    --strict-markers
    --strict-config
    --showlocals
    -v
    
    # پوشش کد
    --cov=src
    --cov-report=term-missing:skip-covered
    --cov-report=html:htmlcov
    --cov-report=xml:coverage.xml
    --cov-branch
    --cov-fail-under=80
    
    # گزارش‌ها
    --junitxml=test-results/junit.xml
    --html=test-results/report.html
    --self-contained-html
    
    # عملکرد
    --tb=short
    --maxfail=3
    --timeout=300
    
    # موازی‌سازی
    -n=auto
    --dist=loadgroup
    
    # امنیت
    --durations=10

# ═══════════════════════════════════════════════════════════════
# 📁 الگوهای فایل
# ═══════════════════════════════════════════════════════════════
python_files = test_*.py *_test.py
python_classes = Test* *Tests
python_functions = test_*

norecursedirs =
    .git
    .tox
    .eggs
    *.egg
    dist
    build
    docs
    .venv
    venv
    __pycache__
    .pytest_cache
    .mypy_cache
    .ruff_cache
    htmlcov
    test-results
    node_modules

# ═══════════════════════════════════════════════════════════════
# ⚡ تنظیمات asyncio (به‌صورت پیش‌فرض پلاگین نسخه فعلی گزینهٔ asyncio_mode را نمی‌شناسد)
# ═══════════════════════════════════════════════════════════════
# asyncio_mode = auto

# ═══════════════════════════════════════════════════════════════
# 🌍 متغیرهای محیطی
# ═══════════════════════════════════════════════════════════════
env =
    TZ=Asia/Tehran
    PYTHONWARNINGS=default
    PYTHONHASHSEED=0
    PYTHONDONTWRITEBYTECODE=1
    PYTHONUNBUFFERED=1
    TEST_ENV=ci
    TESTING=1

# ═══════════════════════════════════════════════════════════════
# 🏷️ نشانگرها
# ═══════════════════════════════════════════════════════════════
markers =
    smoke: آزمون‌های دود
    e2e: آزمون‌های انتهابه‌انتها
    integration: آزمایش‌های یکپارچه‌سازی
    unit: آزمون‌های واحد
    golden: آزمون‌های مقایسه فایل‌های طلایی
    performance: آزمایش‌های کارایی
    security: آزمایش‌های امنیتی
    observability: آزمون‌های لاگ و متریک
    realtime: آزمون‌های به‌روزرسانی لحظه‌ای
    concurrent: آزمون‌های همزمانی
    asyncio: آزمون‌های asyncio
    slow: آزمون‌های کند (>5s)
    resources: آزمون‌های مصرف منابع
    stress: آزمون‌های تنش
    memory: آزمون‌های حافظه
    ui: آزمون‌های رابط کاربری
    cli: آزمون‌های CLI
    farsi_errors: آزمون‌های خطای فارسی
    counter_validation: اعتبارسنجی شمارنده‌ها
    integration_excel: یکپارچه‌سازی اکسل
    retry_logic: منطق تلاش مجدد
    middleware: میان‌افزارها
    metrics: متریک‌ها
    docker: نیاز به Docker
    network: نیاز به شبکه
    database: نیاز به پایگاه داده
    redis: نیاز به Redis
    ci: آزمون‌های CI
    skip: موقتاً غیرفعال
    xfail: انتظار شکست
    flaky: ناپایدار

# ═══════════════════════════════════════════════════════════════
# ⚠️ مدیریت هشدارها (تغییر از error به default!)
# ═══════════════════════════════════════════════════════════════
filterwarnings =
    default
    ignore::DeprecationWarning
    ignore::PendingDeprecationWarning
    ignore::ImportWarning
    ignore::ResourceWarning

# ═══════════════════════════════════════════════════════════════
# 📊 تنظیمات لاگ
# ═══════════════════════════════════════════════════════════════
log_cli = true
log_cli_level = INFO
log_cli_format = %(asctime)s [%(levelname)s] %(name)s: %(message)s
log_cli_date_format = %Y-%m-%d %H:%M:%S

log_file = test-results/pytest.log
log_file_level = DEBUG
log_file_format = %(asctime)s [%(levelname)s] %(name)s: %(message)s
log_file_date_format = %Y-%m-%d %H:%M:%S

# ═══════════════════════════════════════════════════════════════
# 💾 Cache
# ═══════════════════════════════════════════════════════════════
cache_dir = .pytest_cache

# ═══════════════════════════════════════════════════════════════
# 🔧 تنظیمات پیشرفته
# ═══════════════════════════════════════════════════════════════
xdist_strict = true
tmp_path_retention_count = 3
tmp_path_retention_policy = failed

# ═══════════════════════════════════════════════════════════════
# 🎨 Qt Testing
# ═══════════════════════════════════════════════════════════════
qt_api = pyqt5
qt_no_exception_capture = 0
qt_wait_signal_raising = true

# ═══════════════════════════════════════════════════════════════
# 🔐 Timeout
# ═══════════════════════════════════════════════════════════════
timeout = 300
timeout_func_only = false
