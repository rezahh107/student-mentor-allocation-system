# فاز ۶ — خروجی‌گیر ImportToSabt

این سند سیاست‌های نهایی‌سازی فاز ششم را برای تولید خروجی‌های CSV/XLSX خلاصه می‌کند.

## Backend پیش‌فرض XLSX

- مسیر `src/phase6_import_to_sabt/export_writer.py` از **xlsxwriter** در حالت `constant_memory` استفاده می‌کند.
- این backend فقط دادهٔ آماده‌شده را استریم می‌کند؛ هیچ‌گاه کل فایل در حافظه لود نمی‌شود.
- مسیر قدیمی openpyxl فقط برای سناریوهای legacy/خواندن حفظ شده است و در خروجی‌گیری جدید نقشی ندارد.

## CSV با CRLF صریح

- همهٔ خروجی‌های CSV با `lineterminator="\r\n"` تولید می‌شوند.
- ستون‌های حساس (`national_id`، `counter`، `mobile`، `mentor_id`، `school_code`) همیشه quote می‌شوند و محافظ فرمول فعال است.
- BOM به صورت اختیاری باقی مانده و رمزگذاری UTF-8 است.

## ایمنی و اتمیک بودن

- هم CSV و هم XLSX ابتدا با پسوند `.part` نوشته، سپس `fsync` و در نهایت با `os.replace` جابه‌جا می‌شوند.
- متریک‌های Prometheus پس از نهایی‌سازی ثبت می‌شوند و شمارنده‌ها باید پس از تست‌های استرس صفر باقی بمانند.
- دانلودها از روی manifest امضا شده سرویس می‌شوند؛ کانترهای `download_*` پس از هر تست بازنشانی می‌شوند.

## ناحیهٔ زمانی

- تمام timestampها با Clock تزریق‌شده (Asia/Tehran) تولید می‌شود؛ هیچ اشاره‌ای به `Asia/Baku` خارج از نمونه‌های مستندات مجاز نیست.
